name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        default: '1.0.0'

env:
  GO_VERSION: '1.21'
  NODE_VERSION: '20'  # ä½¿ç”¨æ›´ç¨³å®šçš„LTSç‰ˆæœ¬

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Verify environment
        run: |
          echo "Go version:"
          go version
          echo "Node version:"
          node --version
          echo "npm version:"
          npm --version
          echo "Working directory:"
          pwd
          echo "Environment variables:"
          echo "PATH=$env:PATH"

      - name: Setup npm environment
        run: |
          # é‡æ–°å®‰è£…npmåˆ°æ­£ç¡®ä½ç½®
          npm install -g npm@latest
          npm --version
          npm config list

      - name: Install Wails
        run: |
          echo "Installing Wails..."
          go install github.com/wailsapp/wails/v2/cmd/wails@latest
          echo "Wails version:"
          wails version

      - name: Install Go dependencies
        run: |
          echo "Installing Go dependencies..."
          go mod tidy
          go mod download

      - name: Install frontend dependencies
        run: |
          echo "Installing frontend dependencies..."
          cd frontend
          if (Test-Path "package-lock.json") {
            Remove-Item "package-lock.json" -Force
          }
          if (Test-Path "node_modules") {
            Remove-Item "node_modules" -Recurse -Force
          }
          npm install
          echo "Frontend dependencies installed successfully"

      - name: Build Windows app
        run: |
          echo "Building Windows application..."
          wails build -platform windows/amd64 -ldflags "-s -w" -tags desktop
        env:
          CGO_ENABLED: 1

      - name: Verify build output
        run: |
          echo "Checking build output..."
          if (Test-Path "build/bin/ProxyWoman.exe") {
            echo "âœ… ProxyWoman.exe found"
            $size = (Get-Item "build/bin/ProxyWoman.exe").Length / 1MB
            echo "File size: $([math]::Round($size, 2)) MB"
          } else {
            echo "âŒ ProxyWoman.exe not found"
            echo "Build directory contents:"
            Get-ChildItem -Recurse build/ -ErrorAction SilentlyContinue
            exit 1
          }

      - name: Create Windows package
        run: |
          echo "Creating Windows package..."
          New-Item -ItemType Directory -Path "dist" -Force
          $version = "${{ github.event.inputs.version || github.ref_name }}"
          $version = $version -replace '^v', ''
          
          $tempDir = "temp_windows"
          New-Item -ItemType Directory -Path $tempDir -Force
          Copy-Item "build/bin/ProxyWoman.exe" -Destination $tempDir
          
          if (Test-Path "README.md") {
            Copy-Item "README.md" -Destination $tempDir
          }
          
          # åˆ›å»ºå¯åŠ¨è„šæœ¬
          @"
          @echo off
          echo ========================================
          echo       ProxyWoman v$version
          echo ========================================
          echo.
          echo Starting ProxyWoman...
          echo Web UI: http://localhost:3000
          echo Proxy Server: http://localhost:8080
          echo.
          echo Press Ctrl+C to stop the application
          echo ========================================
          echo.
          ProxyWoman.exe
          pause
          "@ | Out-File -FilePath "$tempDir/start.bat" -Encoding ASCII
          
          # åˆ›å»ºZIPåŒ…
          $zipName = "ProxyWoman-$version-Windows.zip"
          Compress-Archive -Path "$tempDir/*" -DestinationPath "dist/$zipName"
          Remove-Item -Recurse -Force $tempDir
          
          echo "âœ… Package created: dist/$zipName"
          $zipSize = (Get-Item "dist/$zipName").Length / 1MB
          echo "Package size: $([math]::Round($zipSize, 2)) MB"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-package
          path: dist/ProxyWoman-*-Windows.zip
          retention-days: 30

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Verify environment
        run: |
          echo "Go version:"
          go version
          echo "Node version:"
          node --version
          echo "npm version:"
          npm --version
          echo "Working directory:"
          pwd
          echo "PATH: $PATH"

      - name: Install Wails
        run: |
          echo "Installing Wails..."
          go install github.com/wailsapp/wails/v2/cmd/wails@latest
          echo "Wails version:"
          wails version

      - name: Install Go dependencies
        run: |
          echo "Installing Go dependencies..."
          go mod tidy
          go mod download

      - name: Install frontend dependencies
        run: |
          echo "Installing frontend dependencies..."
          cd frontend
          rm -f package-lock.json
          rm -rf node_modules
          npm install
          echo "Frontend dependencies installed successfully"

      - name: Build macOS app
        run: |
          echo "Building macOS application..."
          export CGO_ENABLED=1
          export CGO_LDFLAGS="-framework UniformTypeIdentifiers"
          wails build -platform darwin/universal -ldflags "-s -w" -tags desktop

      - name: Fix macOS security issues
        run: |
          echo "Fixing macOS security issues..."
          app_name="ProxyWoman"
          app_path="build/bin/${app_name}.app"

          if [ -d "$app_path" ]; then
            # ç§»é™¤éš”ç¦»å±æ€§
            xattr -cr "$app_path" 2>/dev/null || true

            # è®¾ç½®æ‰§è¡Œæƒé™
            chmod +x "$app_path/Contents/MacOS/$app_name" 2>/dev/null || true

            # å°è¯•è‡ªç­¾å
            codesign --force --deep --sign - "$app_path" 2>/dev/null || true

            echo "âœ… Security fixes applied"
          else
            echo "âŒ App not found: $app_path"
            exit 1
          fi

      - name: Verify build output
        run: |
          echo "Checking build output..."
          app_name="ProxyWoman"
          if [ -d "build/bin/${app_name}.app" ]; then
            echo "âœ… ${app_name}.app found"
            du -sh "build/bin/${app_name}.app"
          else
            echo "âŒ ${app_name}.app not found"
            echo "Build directory contents:"
            find build/ -type f 2>/dev/null || true
            exit 1
          fi

      - name: Create macOS package
        run: |
          echo "Creating macOS package..."
          mkdir -p dist
          version="${{ github.event.inputs.version || github.ref_name }}"
          version="${version#v}"
          
          app_name="ProxyWoman"
          temp_dir="temp_dmg"
          rm -rf "$temp_dir"
          mkdir -p "$temp_dir"
          
          # å¤åˆ¶åº”ç”¨
          cp -R "build/bin/${app_name}.app" "$temp_dir/"
          
          # åˆ›å»ºApplicationsé“¾æ¥
          ln -s /Applications "$temp_dir/Applications"
          
          # åˆ›å»ºå®‰è£…æŒ‡å—
          cat > "$temp_dir/å®‰è£…æŒ‡å—.txt" << 'EOF'
          ProxyWoman macOS å®‰è£…æŒ‡å—

          å¦‚æœé‡åˆ°"æ— æ³•éªŒè¯å¼€å‘è€…"é”™è¯¯ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

          æ–¹æ³•1 - å³é”®èœå•ï¼ˆæ¨èï¼‰:
          1. å³é”®ç‚¹å‡» ProxyWoman.app
          2. é€‰æ‹© "æ‰“å¼€"
          3. åœ¨å¯¹è¯æ¡†ä¸­ç‚¹å‡» "æ‰“å¼€"

          æ–¹æ³•2 - ç³»ç»Ÿåå¥½è®¾ç½®:
          1. å°è¯•æ‰“å¼€åº”ç”¨ï¼ˆä¼šæ˜¾ç¤ºé”™è¯¯ï¼‰
          2. æ‰“å¼€ ç³»ç»Ÿåå¥½è®¾ç½® â†’ å®‰å…¨æ€§ä¸éšç§
          3. åœ¨ é€šç”¨ æ ‡ç­¾é¡µåº•éƒ¨ï¼Œç‚¹å‡» "ä»è¦æ‰“å¼€"

          æ–¹æ³•3 - ç»ˆç«¯å‘½ä»¤:
          sudo xattr -cr /Applications/ProxyWoman.app

          å¯åŠ¨åè®¿é—®: http://localhost:3000
          ä»£ç†è®¾ç½®: 127.0.0.1:8080
          EOF

          # æ·»åŠ README
          if [ -f "README.md" ]; then
            cp "README.md" "$temp_dir/"
          fi

          # åˆ›å»ºDMG
          dmg_name="ProxyWoman-${version}-macOS"
          echo "Creating DMG: ${dmg_name}.dmg"
          hdiutil create -volname "$app_name" -srcfolder "$temp_dir" -ov -format UDZO -imagekey zlib-level=9 "dist/${dmg_name}.dmg"

          # ç§»é™¤DMGçš„éš”ç¦»å±æ€§
          xattr -cr "dist/${dmg_name}.dmg" 2>/dev/null || true

          rm -rf "$temp_dir"

          echo "âœ… Package created: dist/${dmg_name}.dmg"
          echo "Package size: $(du -h "dist/${dmg_name}.dmg" | cut -f1)"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-package
          path: dist/ProxyWoman-*-macOS.dmg
          retention-days: 30

  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-package
          path: dist/

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-package
          path: dist/

      - name: List artifacts
        run: |
          echo "ğŸ“¦ Release artifacts:"
          ls -la dist/
          echo ""
          echo "ğŸ“Š File sizes:"
          du -h dist/*

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/ProxyWoman-*-Windows.zip
            dist/ProxyWoman-*-macOS.dmg
          draft: false
          prerelease: false
          generate_release_notes: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
