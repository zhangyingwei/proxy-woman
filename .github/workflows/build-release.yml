name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        default: '1.0.0'

env:
  GO_VERSION: '1.21'
  NODE_VERSION: '22.0.0'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install dependencies
        run: |
          go mod tidy
          cd frontend && npm install

      - name: Build Windows app
        run: |
          wails build -platform windows/amd64 -ldflags "-s -w" -tags desktop
        env:
          CGO_ENABLED: 1

      - name: Create Windows package
        run: |
          New-Item -ItemType Directory -Path "dist" -Force
          $version = "${{ github.event.inputs.version || github.ref_name }}"
          $version = $version -replace '^v', ''

          # Verify build output
          if (!(Test-Path "build/bin/ProxyWoman.exe")) {
            Write-Error "ProxyWoman.exe not found!"
            exit 1
          }

          # Create ZIP package
          $tempDir = "temp_windows"
          New-Item -ItemType Directory -Path $tempDir -Force
          Copy-Item "build/bin/ProxyWoman.exe" -Destination $tempDir
          Copy-Item "README.md" -Destination $tempDir -ErrorAction SilentlyContinue
          Copy-Item "LICENSE" -Destination $tempDir -ErrorAction SilentlyContinue

          # Create start script
          @"
          @echo off
          echo Starting ProxyWoman...
          echo Web UI: http://localhost:3000
          echo Proxy: http://localhost:8080
          echo.
          ProxyWoman.exe
          pause
          "@ | Out-File -FilePath "$tempDir/start.bat" -Encoding ASCII

          # Create ZIP
          Compress-Archive -Path "$tempDir/*" -DestinationPath "dist/ProxyWoman-$version-Windows.zip"
          Remove-Item -Recurse -Force $tempDir

          # Verify package
          Write-Host "Package created: dist/ProxyWoman-$version-Windows.zip"
          Write-Host "Package size: $((Get-Item "dist/ProxyWoman-$version-Windows.zip").Length / 1MB) MB"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v3
        with:
          name: windows-package
          path: dist/ProxyWoman-*-Windows.zip

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install dependencies
        run: |
          go mod tidy
          cd frontend && npm install

      - name: Build macOS app
        run: |
          export CGO_ENABLED=1
          export CGO_LDFLAGS="-framework UniformTypeIdentifiers"
          wails build -platform darwin/universal -ldflags "-s -w" -tags desktop

      - name: Create macOS package
        run: |
          mkdir -p dist
          version="${{ github.event.inputs.version || github.ref_name }}"
          version="${version#v}"

          # Verify build output
          app_name="ProxyWoman"
          if [ ! -d "build/bin/${app_name}.app" ]; then
            echo "Error: ${app_name}.app not found!"
            exit 1
          fi

          # Create DMG
          temp_dir="temp_dmg"
          rm -rf "$temp_dir"
          mkdir -p "$temp_dir"

          # Copy app
          cp -R "build/bin/${app_name}.app" "$temp_dir/"

          # Create Applications symlink
          ln -s /Applications "$temp_dir/Applications"

          # Add README to DMG
          if [ -f "README.md" ]; then
            cp "README.md" "$temp_dir/"
          fi

          # Create DMG with better settings
          dmg_name="ProxyWoman-${version}-macOS"
          hdiutil create -volname "$app_name" -srcfolder "$temp_dir" -ov -format UDZO -imagekey zlib-level=9 "dist/${dmg_name}.dmg"

          # Cleanup
          rm -rf "$temp_dir"

          # Verify package
          echo "Package created: dist/${dmg_name}.dmg"
          echo "Package size: $(du -h "dist/${dmg_name}.dmg" | cut -f1)"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v3
        with:
          name: macos-package
          path: dist/ProxyWoman-*-macOS.dmg

  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Windows artifacts
        uses: actions/download-artifact@v3
        with:
          name: windows-package
          path: dist/

      - name: Download macOS artifacts
        uses: actions/download-artifact@v3
        with:
          name: macos-package
          path: dist/

      - name: List artifacts
        run: |
          echo "ðŸ“¦ Release artifacts:"
          ls -la dist/
          echo ""
          echo "ðŸ“Š File sizes:"
          du -h dist/*

      - name: Generate release notes
        id: release_notes
        run: |
          version="${{ github.ref_name }}"
          version="${version#v}"

          cat > release_notes.md << 'EOF'
          # ProxyWoman ${{ github.ref_name }}

          ## ðŸŽ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ

          ProxyWoman æ˜¯ä¸€ä¸ªçŽ°ä»£åŒ–çš„ç½‘ç»œä»£ç†åˆ†æžå·¥å…·ï¼Œå…·æœ‰ä¼˜é›…çš„è®¾è®¡å’Œå¼ºå¤§çš„è„šæœ¬åŠŸèƒ½ã€‚

          ## ðŸ“¦ å®‰è£…åŒ…

          ### Windows
          - **ProxyWoman-${version}-Windows.zip** - Windows ä¾¿æºç‰ˆ
          - æ”¯æŒ Windows 10/11 (64ä½)
          - è§£åŽ‹å³ç”¨ï¼Œæ— éœ€å®‰è£…

          ### macOS
          - **ProxyWoman-${version}-macOS.dmg** - macOS å®‰è£…åŒ…
          - æ”¯æŒ Intel å’Œ Apple Silicon å¤„ç†å™¨
          - æ”¯æŒ macOS 10.15+ (Catalina æˆ–æ›´é«˜ç‰ˆæœ¬)

          ## ðŸš€ ä¸»è¦åŠŸèƒ½

          - âœ… **çŽ°ä»£åŒ–ä»£ç†æœåŠ¡å™¨** - HTTP/HTTPS æµé‡æ‹¦æˆªå’Œåˆ†æž
          - âœ… **ä¼˜é›…çš„ç”¨æˆ·ç•Œé¢** - åŸºäºŽ Svelte çš„çŽ°ä»£åŒ– Web ç•Œé¢
          - âœ… **å®žæ—¶æµé‡ç›‘æŽ§** - å®žæ—¶æ˜¾ç¤ºç½‘ç»œè¯·æ±‚å’Œå“åº”
          - âœ… **å¼ºå¤§çš„è„šæœ¬ç³»ç»Ÿ** - JavaScript è„šæœ¬ä¿®æ”¹è¯·æ±‚å’Œå“åº”
          - âœ… **æ™ºèƒ½åº”ç”¨è¯†åˆ«** - è‡ªåŠ¨è¯†åˆ« 40+ å¸¸è§åº”ç”¨
          - âœ… **Gzip æ”¯æŒ** - è‡ªåŠ¨å¤„ç†åŽ‹ç¼©å“åº”
          - âœ… **è·¨å¹³å°æ”¯æŒ** - Windowsã€macOSã€Linux

          ## ðŸ”§ å¿«é€Ÿå¼€å§‹

          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
          2. Windows: è§£åŽ‹ ZIP æ–‡ä»¶ï¼Œè¿è¡Œ `start.bat`
          3. macOS: æ‰“å¼€ DMG æ–‡ä»¶ï¼Œæ‹–æ‹½åˆ° Applications æ–‡ä»¶å¤¹
          4. è®¿é—® http://localhost:3000 æŸ¥çœ‹ç•Œé¢
          5. è®¾ç½®ä»£ç†ä¸º 127.0.0.1:8080

          ## ðŸ“ æ›´æ–°æ—¥å¿—

          è¯¦ç»†çš„æ›´æ–°å†…å®¹è¯·æŸ¥çœ‹ä¸‹æ–¹çš„è‡ªåŠ¨ç”Ÿæˆçš„æ›´æ–°æ—¥å¿—ã€‚

          ---

          **æž„å»ºä¿¡æ¯:**
          - Go ç‰ˆæœ¬: ${{ env.GO_VERSION }}
          - Node.js ç‰ˆæœ¬: ${{ env.NODE_VERSION }}
          - æž„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/ProxyWoman-*-Windows.zip
            dist/ProxyWoman-*-macOS.dmg
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
